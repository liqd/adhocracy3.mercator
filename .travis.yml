sudo: false
dist: trusty
language: python
branches:
  only:
  - master
python:
- '3.5'
install:
- git fetch --unshallow
- python bootstrap.py --setuptools-version=32.0.0
- PATH=${TRAVIS_BUILD_DIR}/bin:${PATH} ./bin/buildout -c buildout-${BUILDOUT_TARGET}.cfg
  2>/dev/null
before_script:
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
script:
- "./bin/ad_check_code -a"
notifications:
  email: false
cache:
  directories:
  - eggs
  - node_modules
  - parts/wheels
addons:
  firefox: latest-esr
  ssh_known_hosts: russell.partou.org partouls -build-prod-guest12
env:
  matrix:
  - BUILDOUT_TARGET=meinberlin
after_success:
- "./bin/coveralls"
before_deploy:
- openssl aes-256-cbc aes-256-cbc -K $encrypted_98f8f05b1b7a_key -iv $encrypted_98f8f05b1b7a_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- ssh-add /tmp/deploy_rsa
deploy:
  provider: script
  skip_cleanup: true
  script:
  - bin/ad_make_wheels
  - rsync -e "ssh -o ProxyCommand='ssh root@russell.partou.org lxc exec %h nc localhost 22' -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" -r --quiet $TRAVIS_BUILD_DIR/parts/wheels/ build@partou-build-prod-guest12:/var/www/wheels.partou.org/"
